name: Docker Build & Deploy

on:
  # push:
  #   branches: ['**']  # çµ±åˆç‰ˆ deploy-integrated.yml ã«ç§»è¡Œã®ãŸã‚ç„¡åŠ¹åŒ–
  workflow_dispatch:  # ç·Šæ€¥æ™‚ã®å€‹åˆ¥å®Ÿè¡Œç”¨
  # workflow_run:
  #   workflows: ["Deploy Base Infrastructure"]
  #   types: [completed]
  #   branches: ['**']  # çµ±åˆç‰ˆã§ã¯ needs ã§åˆ¶å¾¡

permissions:
  contents: read
  id-token: write

env:
  ENABLE_DOCKER_BUILD: false
  
  REGION: asia-northeast1

jobs:
  validate:
    runs-on: ubuntu-latest
    # workflow_runãƒˆãƒªã‚¬ãƒ¼ã®å ´åˆã¯å‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æˆåŠŸã‚’ãƒã‚§ãƒƒã‚¯
    if: github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.name == 'Deploy Base Infrastructure')
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      branch_name: ${{ steps.env.outputs.branch_name }}
      app_name: ${{ steps.env.outputs.app_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set Environment Variables
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "app_name=x-fact-checker-prod" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "app_name=x-fact-checker-staging" >> $GITHUB_OUTPUT
          fi
          echo "branch_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          
          echo "=== Environment Detection ==="
          echo "Branch: ${{ github.ref_name }}"
          echo "Environment: $([ "${{ github.ref }}" = "refs/heads/main" ] && echo "production" || echo "staging")"
          echo "App Name: $([ "${{ github.ref }}" = "refs/heads/main" ] && echo "x-fact-checker-prod" || echo "x-fact-checker-staging")"
      
      - name: Authenticate to Google Cloud (for prerequisite check)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}
          project_id: ${{ secrets.PROJECT_ID }}
      
      - name: Setup Google Cloud SDK (for prerequisite check)
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Check Base Infrastructure Prerequisites
        run: |
          echo "ğŸ” åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          
          # Artifact Registryãƒªãƒã‚¸ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
          if gcloud artifacts repositories describe fact-checker-repo \
               --location=${{ env.REGION }} \
               --project=${{ secrets.PROJECT_ID }} >/dev/null 2>&1; then
            echo "âœ… Artifact Registry ãƒªãƒã‚¸ãƒˆãƒª (fact-checker-repo) ç¢ºèªæ¸ˆã¿"
          else
            echo "âŒ Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ“‹ å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
            echo "1. infrastructure-base-deploy.yml ã§ ENABLE_BASE_INFRASTRUCTURE=true ã‚’è¨­å®š"
            echo "2. åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"
            echo "3. Terraform Cloud UI ã§ Apply ã‚’å®Ÿè¡Œ"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ ã™ã¹ã¦ã®å‰ææ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã™"
          echo "Docker Build & Push ã‚’é–‹å§‹ã§ãã¾ã™"

  docker-build:
    needs: validate
    runs-on: ubuntu-latest
    if: vars.ENABLE_DOCKER_BUILD == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}
          project_id: ${{ secrets.PROJECT_ID }}
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: |
          echo "ğŸ”§ Dockerèªè¨¼è¨­å®šä¸­..."
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          echo "âœ… Dockerèªè¨¼è¨­å®šå®Œäº†"
      
      - name: Build and Push Docker Image
        env:
          APP_NAME: ${{ needs.validate.outputs.app_name }}
        run: |
          echo "ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰é–‹å§‹"
          IMAGE_SHA="${{ env.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/fact-checker-repo/${{ env.APP_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/fact-checker-repo/${{ env.APP_NAME }}:latest"
          
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã‚¤ãƒ¡ãƒ¼ã‚¸:"
          echo "  SHA tag: $IMAGE_SHA"
          echo "  Latest tag: $IMAGE_LATEST"
          
          # Build and push with SHA tag (with retry)
          echo "ğŸ”¨ ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ..."
          RETRY_COUNT=0
          MAX_RETRIES=3
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if gcloud builds submit --tag "$IMAGE_SHA" --quiet; then
              echo "âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰æˆåŠŸ: $IMAGE_SHA"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âš ï¸ ãƒ“ãƒ«ãƒ‰å¤±æ•— (è©¦è¡Œ $RETRY_COUNT/$MAX_RETRIES)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ğŸ”„ 30ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™..."
                sleep 30
              else
                echo "âŒ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸã€‚å¤±æ•—"
                exit 1
              fi
            fi
          done
          
          # Tag and push as latest (with retry)
          echo "ğŸ·ï¸ latest ã‚¿ã‚°ä½œæˆä¸­..."
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if gcloud container images add-tag "$IMAGE_SHA" "$IMAGE_LATEST" --quiet; then
              echo "âœ… latest ã‚¿ã‚°ä½œæˆå®Œäº†: $IMAGE_LATEST"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âš ï¸ ã‚¿ã‚°ä½œæˆå¤±æ•— (è©¦è¡Œ $RETRY_COUNT/$MAX_RETRIES)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ğŸ”„ 10ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™..."
                sleep 10
              else
                echo "âŒ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸã€‚å¤±æ•—"
                exit 1
              fi
            fi
          done
          
          echo ""
          echo "ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "1. app-deploy.yml ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•çš„ã«é–‹å§‹ã•ã‚Œã¾ã™"
          echo "2. ENABLE_APP_DEPLOY=true ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ"

  safety-report:
    needs: [validate]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Docker Build Safety Status Report
        run: |
          echo "=== ğŸ”’ Docker Buildå®‰å…¨å¼çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ ==="
          echo "ENABLE_DOCKER_BUILD: ${{ vars.ENABLE_DOCKER_BUILD }}"
          echo ""
          echo "=== ğŸ“‹ å®Ÿè¡Œçµæœ ==="
          echo "âœ… Phase 2 (Validate): å¸¸ã«å®Ÿè¡Œ"
          echo "$([ '${{ vars.ENABLE_DOCKER_BUILD }}' = 'true' ] && echo 'âœ…' || echo 'âŒ') Phase 2 (Docker Build): ${{ vars.ENABLE_DOCKER_BUILD }}"
          echo ""
          echo "=== ğŸ“– æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— ==="
          if [ "${{ vars.ENABLE_DOCKER_BUILD }}" != "true" ]; then
            echo "âš ï¸  å‰ææ¡ä»¶ç¢ºèª:"
            echo "1. infrastructure-base-deploy.yml ã§åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©ãŒä½œæˆæ¸ˆã¿ã‹ç¢ºèª"
            echo "2. ENABLE_DOCKER_BUILD=trueã«è¨­å®šã—ã¦Dockerãƒ“ãƒ«ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆ"
            echo "   â†’ Docker imageãŒArtifact Registryã«pushã•ã‚Œã¾ã™"
          else
            echo "ğŸ‰ Docker BuildãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            echo "æ¬¡ã¯ app-deploy.yml ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"
          fi
          
          echo ""
          echo "=== ğŸ”„ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ç¢ºèª ==="
          echo "Phase 1: infrastructure-base-deploy.yml (åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©) â† å®Œäº†å¿…é ˆ"
          echo "Phase 2: docker-build-deploy.yml (Docker Build) â† ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"
          echo "Phase 3: app-deploy.yml (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³) â† æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—"