name: Deploy Base Infrastructure

on:
  # push:
  #   branches: ['**']  # çµ±åˆç‰ˆ deploy-integrated.yml ã«ç§»è¡Œã®ãŸã‚ç„¡åŠ¹åŒ–
  workflow_dispatch:  # ç·Šæ€¥æ™‚ã®å€‹åˆ¥å®Ÿè¡Œç”¨

permissions:
  contents: read
  id-token: write

env:
  ENABLE_BASE_INFRASTRUCTURE: false
  
  REGION: asia-northeast1
  TF_CLOUD_ORGANIZATION: "fact-checker"  # Terraform Cloudçµ„ç¹”å

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      branch_name: ${{ steps.env.outputs.branch_name }}
      workspace_name: ${{ steps.env.outputs.workspace_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set Environment Variables
        id: env
        run: |
          echo "environment=$([ "${{ github.ref }}" = "refs/heads/main" ] && echo "production" || echo "staging")" >> $GITHUB_OUTPUT
          echo "workspace_name=fact-checker-fs" >> $GITHUB_OUTPUT
          echo "branch_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          
          echo "=== Environment Detection ==="
          echo "Branch: ${{ github.ref_name }}"
          echo "Environment: $([ "${{ github.ref }}" = "refs/heads/main" ] && echo "production" || echo "staging")"
          echo "Workspace: fact-checker-fs"
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      
      - name: Terraform Init
        working-directory: ./infrastructure
        env:
          TF_WORKSPACE: ${{ steps.env.outputs.workspace_name }}
        run: terraform init
      
      - name: Terraform Validate
        working-directory: ./infrastructure
        env:
          TF_WORKSPACE: ${{ steps.env.outputs.workspace_name }}
        run: |
          echo "ğŸ” åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©Terraformæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          terraform validate
          echo "âœ… åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©Terraformæ§‹æ–‡ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
      
      - name: Terraform Plan (Dry Run)
        working-directory: ./infrastructure
        env:
          TF_WORKSPACE: ${{ steps.env.outputs.workspace_name }}
          GOOGLE_CREDENTIALS: ${{ secrets.GCLOUD_SERVICE_KEY }}
          GOOGLE_PROJECT: ${{ secrets.PROJECT_ID }}
          TF_VAR_deploy_phase: "base"
        run: |
          echo "ğŸ” åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©Terraform Planå®Ÿè¡Œ"
          terraform plan -var="deploy_phase=base"
          echo "âœ… åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©Terraform PlanæˆåŠŸ"
          
          echo "=== å®‰å…¨å¼çŠ¶æ³ ==="
          echo "ENABLE_BASE_INFRASTRUCTURE: ${{ env.ENABLE_BASE_INFRASTRUCTURE }}"

  terraform-apply:
    needs: validate
    runs-on: ubuntu-latest
    if: vars.ENABLE_BASE_INFRASTRUCTURE == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}
          project_id: ${{ secrets.PROJECT_ID }}
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      
      - name: Terraform Init (Terraform Cloud)
        working-directory: ./infrastructure
        env:
          TF_WORKSPACE: ${{ needs.validate.outputs.workspace_name }}
        run: |
          echo "ğŸš€ åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©TerraformåˆæœŸåŒ–ä¸­..."
          terraform init
          echo "âœ… åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©TerraformåˆæœŸåŒ–å®Œäº†"
      
      - name: Terraform Plan (triggers Terraform Cloud)
        working-directory: ./infrastructure
        env:
          TF_WORKSPACE: ${{ needs.validate.outputs.workspace_name }}
          GOOGLE_CREDENTIALS: ${{ secrets.GCLOUD_SERVICE_KEY }}
          GOOGLE_PROJECT: ${{ secrets.PROJECT_ID }}
          TF_VAR_deploy_phase: "base"
        run: |
          echo "ğŸš€ åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©Terraform Planå®Ÿè¡Œã§Terraform Cloudã‚’ãƒˆãƒªã‚¬ãƒ¼"
          terraform plan -var="deploy_phase=base"
          echo "âœ… åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©Planå®Œäº† - Terraform Cloud UIã§Applyç¢ºèªãƒ»å®Ÿè¡Œã—ã¦ãã ã•ã„"
          echo ""
          echo "ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "1. Terraform Cloud UI: https://app.terraform.io/app/fact-checker/workspaces/fact-checker-fs"
          echo "2. æœ€æ–°Runã®è©³ç´°ã‚’ç¢ºèª"
          echo "3. Auto-applyç„¡åŠ¹ã®å ´åˆã¯æ‰‹å‹•ã§Applyãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"
          echo ""
          echo "ğŸ“¦ ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹:"
          echo "- Artifact Registry ãƒªãƒã‚¸ãƒˆãƒª (fact-checker-repo)"

  safety-report:
    needs: [validate]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Base Infrastructure Safety Status Report
        run: |
          echo "=== ğŸ”’ åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©å®‰å…¨å¼çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ ==="
          echo "ENABLE_BASE_INFRASTRUCTURE: ${{ vars.ENABLE_BASE_INFRASTRUCTURE }}"
          echo ""
          echo "=== ğŸ“‹ å®Ÿè¡Œçµæœ ==="
          echo "âœ… Phase 1 (Validate): å¸¸ã«å®Ÿè¡Œ"
          echo "$([ '${{ vars.ENABLE_BASE_INFRASTRUCTURE }}' = 'true' ] && echo 'âœ…' || echo 'âŒ') Phase 1 (Base Infrastructure Deploy): ${{ vars.ENABLE_BASE_INFRASTRUCTURE }}"
          echo ""
          echo "=== ğŸ“– æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— ==="
          if [ "${{ vars.ENABLE_BASE_INFRASTRUCTURE }}" != "true" ]; then
            echo "1. ENABLE_BASE_INFRASTRUCTURE=trueã«è¨­å®šã—ã¦åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒ†ã‚¹ãƒˆ"
            echo "   â†’ Artifact Registryãƒªãƒã‚¸ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã™"
            echo "2. åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©ä½œæˆå¾Œã€Docker Build & PushãŒå¯èƒ½ã«ãªã‚Šã¾ã™"
          else
            echo "ğŸ‰ åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            echo "æ¬¡ã¯ docker-build-deploy.yml ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"
          fi